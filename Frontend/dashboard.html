<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Game ONN - Dashboard</title>
    <style>
        .modal-footer {
            text-align: right;
            margin-top: 20px;
        }
        #confirm-book-btn {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            cursor: pointer;
        }
        #confirm-book-btn:hover {
            background: #45a049;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
        }
        .modal-content {
            background-color: #2c2c2c;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 400px;
            border-radius: 10px;
            color: white;
        }
        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-btn:hover,
        .close-btn:focus {
            color: #fff;
            text-decoration: none;
            cursor: pointer;
        }
        #games-list {
            list-style-type: none;
            padding: 0;
        }
        #games-list li {
            background-color: #444;
            margin: 5px 0;
            padding: 10px;
            border-radius: 5px;
        }

        body { font-family: Arial, sans-serif; background: #1a1a1a; color: white; }
        h1 { text-align: center; color: #4CAF50; }
        #slots-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            padding: 20px;
        }
        .slot-card {
            background: #333;
            border: 1px solid #4CAF50;
            border-radius: 8px;
            padding: 15px;
            width: 200px;
            text-align: center;
        }
        .slot-card h3 { margin-top: 0; }
        .book-btn {
            background: #4CAF50;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
        .book-btn:hover { background: #45a049; }
    </style>
</head>
<body>

<div class="user-info" style="text-align: right; padding: 10px 20px; background-color: #222; border-bottom: 1px solid #444;">
    <span id="welcome-message"></span>
    <a href="#" onclick="logout()" style="color: #d9534f; margin-left: 15px; text-decoration: none;">Logout</a>
</div>

    <h1>Available Gaming Slots</h1>
    
    <nav style="text-align: center; margin: 20px 0;">
        <a href="index.html" style="color: #4CAF50; margin: 0 15px;">Home</a>
    </nav>
    
    <div id="slots-container">
    </div>

   <div id="games-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h2>Available Games</h2>
        <ul id="games-list"></ul>

        <div class="booking-times" style="margin-top: 15px;">
            <label for="start-time" style="display: block; margin-bottom: 5px;">Start Time:</label>
            <input type="datetime-local" id="start-time" style="width: 100%; padding: 8px; box-sizing: border-box;">
            
            <label for="duration-hours" style="display: block; margin-top: 10px; margin-bottom: 5px;">Duration (Hours):</label>
            <input type="number" id="duration-hours" value="1" min="1" max="8" style="width: 100%; padding: 8px; box-sizing: border-box;">
        </div>

        <div class="modal-footer">
            <button id="confirm-book-btn">Confirm Booking</button>
        </div>
    </div>
</div>

<script>
const username = localStorage.getItem('username');
if (username) {
    document.getElementById('welcome-message').textContent = `Welcome, ${username}!`;
}

function logout() {
    localStorage.removeItem('userId');
    localStorage.removeItem('username');
    window.location.href = 'login.html';
}

    const modal = document.getElementById('games-modal');
    const closeBtn = document.querySelector('.close-btn');
    const gamesList = document.getElementById('games-list');
    const confirmBtn = document.getElementById('confirm-book-btn');
    const slotsContainer = document.getElementById('slots-container');

    function openModal() {
        modal.style.display = 'block';
    }
    function closeModal() {
        modal.style.display = 'none';
    }
    closeBtn.onclick = closeModal;
    window.onclick = function(event) {
        if (event.target == modal) {
            closeModal();
        }
    };

    async function loadSlots() {
        try {
            const response = await fetch('http://localhost:3000/slots');
            const slots = await response.json();
            slotsContainer.innerHTML = '';

            slots.forEach(slot => {
                const card = document.createElement('div');
                card.className = 'slot-card';
                
                let bookButton = '';
                if (slot.availability) {
                    bookButton = `<button class="book-btn" data-slot-id="${slot.slot_id}">Book Now</button>`;
                }

                card.innerHTML = `
                    <h3>${slot.slot_name}</h3>
                    <p>Type: ${slot.slot_type}</p>
                    <p>Rate: ‚Çπ${slot.rate}/hour</p>
                    <p>Status: <strong>${slot.availability ? 'Available' : 'Booked'}</strong></p>
                    ${bookButton}
                `;
                slotsContainer.appendChild(card);
            });
        } catch (error) {
            console.error('Failed to fetch slots:', error);
            slotsContainer.innerHTML = '<p>Error loading slots.</p>';
        }
    }

    slotsContainer.addEventListener('click', async function(e) {
        if (e.target && e.target.classList.contains('book-btn')) {
            const slotId = e.target.dataset.slotId;
            modal.dataset.slotId = slotId;

            try {
                const response = await fetch(`http://localhost:3000/slots/${slotId}/games`);
                const games = await response.json();
                gamesList.innerHTML = '';
                if (games.length > 0) {
                    games.forEach(game => {
                        const li = document.createElement('li');
                        li.textContent = `${game.game_name} (${game.genre})`;
                        gamesList.appendChild(li);
                    });
                } else {
                    gamesList.innerHTML = '<li>No specific games listed for this slot.</li>';
                }

                const startTimeInput = document.getElementById('start-time');
                const now = new Date();
                const maxDate = new Date(now.setDate(now.getDate() + 7));
                const maxDateString = maxDate.toISOString().slice(0, 16);
                startTimeInput.max = maxDateString;
                
                openModal();

            } catch (error) {
                console.error('Failed to fetch games:', error);
                alert('Could not load the game list.');
            }
        }
    });

    confirmBtn.addEventListener('click', async function() {
        const slotId = modal.dataset.slotId;
        const userId = localStorage.getItem('userId');
        
        if (!userId) {
            alert("Please login first");
            window.location.href = 'login.html';
            return;
        }
        
        const startTime = document.getElementById('start-time').value;
        const durationHours = document.getElementById('duration-hours').value;

        if (!startTime || !durationHours) {
            alert("Please select a start time and duration.");
            return;
        }

        const selectedDate = new Date(startTime);
        const selectedHour = selectedDate.getHours();

        if (selectedDate < new Date()) {
            alert("You cannot book a time in the past.");
            return;
        }
        if (selectedHour < 10 || selectedHour >= 22) {
            alert("Bookings are only allowed between 10:00 AM and 10:00 PM.");
            return;
        }

        const slotElement = document.querySelector(`[data-slot-id="${slotId}"]`).closest('.slot-card');
        const rateText = slotElement.querySelector('p:nth-child(3)').textContent;
        const slotRate = parseInt(rateText.replace('Rate: ‚Çπ', '').replace('/hour', '')) || 50;
        const hours = parseInt(durationHours);
        const totalAmount = hours * slotRate;

        showMockPayment(totalAmount, slotId, userId, startTime, durationHours);
    });

    function showMockPayment(amount, slotId, userId, startTime, durationHours) {
        const paymentHTML = `
            <div style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; justify-content:center; align-items:center; z-index:1000;">
                <div style="background:#333; padding:30px; border-radius:10px; text-align:center; color:white; width:350px;">
                    <h3>üí≥ Confirm Payment</h3>
                    <p style="font-size: 1.2em; margin: 20px 0;">Total Amount: <strong>‚Çπ${amount}</strong></p>
                    
                    <button onclick="processMockPayment(${amount}, '${slotId}', '${userId}', '${startTime}', ${durationHours})" 
                            style="background:#4CAF50; color:white; padding:12px 25px; border:none; border-radius:5px; margin:5px; cursor:pointer; width:100%; font-size: 1.1em;">
                        Pay ‚Çπ${amount}
                    </button>
                    <button onclick="closeMockPayment()" 
                            style="background:#d9534f; color:white; padding:12px 25px; border:none; border-radius:5px; margin:5px; cursor:pointer; width:100%;">
                        Cancel
                    </button>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', paymentHTML);
    }

    async function processMockPayment(amount, slotId, userId, startTime, durationHours) {
        const payButton = document.querySelector('[onclick*="processMockPayment"]');
        payButton.innerHTML = 'Processing...';
        payButton.disabled = true;
        
        setTimeout(async () => {
            try {
                const response = await fetch('http://localhost:3000/book', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        slot_id: slotId, 
                        user_id: userId,
                        start_time: startTime,
                        duration_hours: parseInt(durationHours)
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    const bookingId = result.booking_id;
                    
                    closeMockPayment();
                    closeModal();
                    loadSlots();
                    
                    alert(`‚úÖ Booking Confirmed!\nBooking ID: ${bookingId}\nAmount: ‚Çπ${amount}`);
                    
                    const wantsSnacks = confirm("Would you like to order snacks for your booking?");
                    if (wantsSnacks) {
                        localStorage.setItem('currentBookingId', bookingId);
                        window.location.href = 'snacks.html';
                    }
                    
                } else {
                    const errorText = await response.text();
                    closeMockPayment();
                    alert(`‚ùå Booking failed: ${errorText}`);
                }
                
            } catch (error) {
                closeMockPayment();
                alert("‚ùå Error processing booking.");
                console.error('Booking error after payment:', error);
            }
        }, 1500);
    }

    function closeMockPayment() {
        const paymentModal = document.querySelector('[style*="position:fixed"]');
        if (paymentModal) {
            paymentModal.remove();
        }
    }

    window.onload = function() {
        const userId = localStorage.getItem('userId');
        if (!userId) {
            alert("Please login first");
            window.location.href = 'login.html';
            return;
        }
        loadSlots();
    };
</script>

</body>
</html>